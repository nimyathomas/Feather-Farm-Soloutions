{% extends 'admindash.html' %}

{% block body %}
<div class="container-fluid px-4">
    <div class="row my-4">
        <div class="col">
            <h2 class="text-primary">
                <i class="fas fa-syringe me-2"></i>Vaccine Management
            </h2>
        </div>
        <div class="col text-end">
            <button class="btn btn-primary" onclick="openAddVaccineModal()">
                <i class="fas fa-plus me-2"></i>Add New Vaccine
            </button>
        </div>
    </div>

    <!-- Day 7 Vaccines -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">7th Day Vaccines</h5>
        </div>
        <div class="card-body">
            {% include 'vaccine_table.html' with vaccines=day_7_vaccines %}
        </div>
    </div>

    <!-- Day 14 Vaccines -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">14th Day Vaccines</h5>
        </div>
        <div class="card-body">
            {% include 'vaccine_table.html' with vaccines=day_14_vaccines %}
        </div>
    </div>

    <!-- Day 21 Vaccines -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">21st Day Vaccines</h5>
        </div>
        <div class="card-body">
            {% include 'vaccine_table.html' with vaccines=day_21_vaccines %}
        </div>
    </div>
</div>

<!-- Add/Edit Vaccine Modal -->
<div class="modal fade" id="vaccineModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Vaccine</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="vaccineForm" method="POST">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="name">Name*</label>
                        <input type="text" class="form-control" id="name" name="name" required maxlength="100">
                    </div>
                    <div class="mb-3">
                        <label for="manufacturer">Manufacturer*</label>
                        <input type="text" class="form-control" id="manufacturer" name="manufacturer" required maxlength="100">
                    </div>
                    <div class="mb-3">
                        <label for="vaccination_day">Vaccination Day*</label>
                        <select class="form-select" id="vaccination_day" name="vaccination_day" required>
                            <option value="">Select vaccination day...</option>
                            <option value="7">7th Day</option>
                            <option value="14">14th Day</option>
                            <option value="21">21st Day</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="doses_required">Doses Required*</label>
                        <input type="number" 
                               class="form-control" 
                               id="doses_required" 
                               name="doses_required" 
                               min="1" 
                               value="1" 
                               required>
                        <small class="form-text text-muted">Number of doses required for this vaccine</small>
                    </div>
                    <div class="mb-3">
                        <label for="interval_days">Interval Days*</label>
                        <input type="number" 
                               class="form-control" 
                               id="interval_days" 
                               name="interval_days" 
                               min="1" 
                               value="7" 
                               required>
                        <small class="form-text text-muted">Number of days between doses</small>
                    </div>
                    <div class="mb-3">
                        <label for="current_stock">Current Stock*</label>
                        <input type="number" class="form-control" id="current_stock" name="current_stock" min="0" value="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="minimum_stock_level">Minimum Stock Level*</label>
                        <input type="number" class="form-control" id="minimum_stock_level" name="minimum_stock_level" min="0" value="10" required>
                    </div>
                    <div class="mb-3">
                        <label for="batch_number">Batch Number</label>
                        <input type="text" class="form-control" id="batch_number" name="batch_number" maxlength="50">
                    </div>
                    <div class="mb-3">
                        <label for="expiry_date">Expiry Date</label>
                        <input type="date" class="form-control" id="expiry_date" name="expiry_date">
                    </div>
                    <div class="mb-3">
                        <label for="notes">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" maxlength="500"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveVaccine()">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
// Add this function at the top of your script section
function openAddVaccineModal() {
    console.log('Opening modal...'); // Debug log
    document.getElementById('modalTitle').textContent = 'Add New Vaccine';
    document.getElementById('vaccineForm').reset();
    const modal = new bootstrap.Modal(document.getElementById('vaccineModal'));
    modal.show();
}

// Add this function for saving the vaccine
async function saveVaccine() {
    const form = document.getElementById('vaccineForm');
    const formData = new FormData(form);
    
    // Debug log
    for (let pair of formData.entries()) {
        console.log(pair[0] + ': ' + pair[1]);
    }
    
    try {
        const response = await fetch('{% url "add_vaccine" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
        });
        
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
            const data = await response.json();
            if (data.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('vaccineModal'));
                modal.hide();
                window.location.reload();
            } else {
                const errorMessage = data.errors ? 
                    Object.entries(data.errors).map(([key, value]) => `${key}: ${value}`).join('\n') :
                    data.message || 'Unknown error';
                alert('Error saving vaccine:\n' + errorMessage);
            }
        } else {
            const text = await response.text();
            console.error('Non-JSON response:', text);
            throw new Error('Invalid server response');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error saving vaccine. Please check the form and try again.');
    }
}

// Remove the form submit event listener since we're using the Save button
document.getElementById('vaccineForm').onsubmit = function(e) {
    e.preventDefault();
};
</script>
{% endblock %}

<!-- Bootstrap JS, Popper.js, and CSS (Include these files if not already included in your base template) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
