{% extends 'admindash.html' %}
{% load static %}

{% block body %}
<div class="vaccine-dashboard">
    <!-- Header Section -->
    <div class="page-header">
        <div class="header-content">
            <h1><i class="fas fa-chart-line"></i> Vaccine Dashboard</h1>
            <p>Real-time overview of vaccination program</p>
        </div>
        <div class="header-actions">
            <button class="btn-primary" onclick="openAddVaccineModal()">
                <i class="fas fa-plus"></i> Add New Vaccine
            </button>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card primary-gradient">
            <div class="stat-icon">
                <i class="fas fa-syringe"></i>
            </div>
            <div class="stat-info">
                <h3>Total Vaccines</h3>
                <div class="stat-value">{{ total_vaccines }}</div>
                <div class="stat-change increase">
                    <i class="fas fa-arrow-up"></i> 12% from last month
                </div>
            </div>
        </div>

        <div class="stat-card success-gradient">
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <h3>Vaccinations Done</h3>
                <div class="stat-value">{{ completed_vaccinations }}</div>
                <div class="stat-change increase">
                    <i class="fas fa-arrow-up"></i> 8% this week
                </div>
            </div>
        </div>

        <div class="stat-card warning-gradient">
            <div class="stat-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <h3>Pending</h3>
                <div class="stat-value">{{ pending_vaccinations }}</div>
                <div class="stat-change">
                    Next in 2 days
                </div>
            </div>
        </div>

        <div class="stat-card danger-gradient">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-info">
                <h3>Stock Alerts</h3>
                <div class="stat-value">{{ low_stock_count }}</div>
                <div class="stat-change">
                    Requires attention
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
        <!-- Vaccine List -->
        <div class="dashboard-card vaccine-list-card">
            <div class="card-header">
                <h2>Manage Vaccines</h2>
                <div class="search-box">
                    <input type="text" id="vaccineSearch" placeholder="Search vaccines...">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            <div class="vaccine-list">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Manufacturer</th>
                            <th>Doses</th>
                            <th>Interval</th>
                            <th>Stock</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vaccineTableBody">
                        {% for vaccine in vaccines %}
                        <tr data-vaccine-id="{{ vaccine.id }}">
                            <td>{{ vaccine.name }}</td>
                            <td>{{ vaccine.manufacturer }}</td>
                            <td>{{ vaccine.doses_required }}</td>
                            <td>{{ vaccine.interval_days }} days</td>
                            <td>
                                <div class="stock-indicator {% if vaccine.current_stock < 30 %}low{% endif %}">
                                    {{ vaccine.current_stock }}
                                </div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button onclick="editVaccine({{ vaccine.id }})" class="btn-icon">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteVaccine({{ vaccine.id }})" class="btn-icon danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Stock Overview -->
        <div class="dashboard-card stock-card">
            <div class="card-header">
                <h2>Stock Overview</h2>
                <button class="btn-outline-small" onclick="location.href='{% url 'vaccine_stock_level' %}'">
                    Manage Stock
                </button>
            </div>
            <div class="stock-list">
                {% for stock in vaccine_stocks %}
                <div class="stock-item">
                    <div class="stock-info">
                        <h4>{{ stock.vaccine_name }}</h4>
                        <div class="stock-progress">
                            <div class="progress-bar">
                                <div class="progress" style="width: {{ stock.stock_percentage }}%"></div>
                            </div>
                            <span class="stock-count">{{ stock.current_stock }}/{{ stock.max_stock }}</span>
                        </div>
                    </div>
                    {% if stock.status == 'LOW' %}
                    <div class="stock-alert">
                        <i class="fas fa-exclamation-circle"></i>
                        Low Stock
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Vaccine Modal -->
<div class="modal" id="vaccineModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Add New Vaccine</h3>
            <button onclick="closeModal()" class="close-btn">&times;</button>
        </div>
        <form id="vaccineForm" onsubmit="handleVaccineSubmit(event)">
            {% csrf_token %}
            <input type="hidden" id="vaccineId">
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="vaccineName" required>
            </div>
            <div class="form-group">
                <label>Manufacturer</label>
                <input type="text" id="manufacturer" required>
            </div>
            <div class="form-group">
                <label>Doses Required</label>
                <input type="number" id="dosesRequired" min="1" required>
            </div>
            <div class="form-group">
                <label>Interval (days)</label>
                <input type="number" id="intervalDays" min="1" required>
            </div>
            <div class="form-group">
                <label>Current Stock</label>
                <input type="number" id="currentStock" min="0" required>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal()" class="btn-secondary">Cancel</button>
                <button type="submit" class="btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
function openAddVaccineModal() {
    document.getElementById('modalTitle').textContent = 'Add New Vaccine';
    document.getElementById('vaccineForm').reset();
    document.getElementById('vaccineId').value = '';
    document.getElementById('vaccineModal').style.display = 'block';
}

async function editVaccine(id) {
    try {
        const response = await fetch(`/get-vaccine/${id}/`);
        const data = await response.json();
        
        if (data.success) {
            // Fill the modal with vaccine data
            document.getElementById('modalTitle').textContent = 'Edit Vaccine';
            document.getElementById('vaccineId').value = id;
            document.getElementById('vaccineName').value = data.vaccine.name;
            document.getElementById('manufacturer').value = data.vaccine.manufacturer;
            document.getElementById('dosesRequired').value = data.vaccine.doses_required;
            document.getElementById('intervalDays').value = data.vaccine.interval_days;
            document.getElementById('currentStock').value = data.vaccine.current_stock;
            
            // Show the modal
            document.getElementById('vaccineModal').style.display = 'block';
        } else {
            alert('Error loading vaccine data');
        }
    } catch (error) {
        alert('Error loading vaccine data');
        console.error(error);
    }
}

function closeModal() {
    document.getElementById('vaccineModal').style.display = 'none';
}

async function handleVaccineSubmit(event) {
    event.preventDefault();
    const vaccineId = document.getElementById('vaccineId').value;
    
    const formData = new FormData();
    formData.append('name', document.getElementById('vaccineName').value);
    formData.append('manufacturer', document.getElementById('manufacturer').value);
    formData.append('doses_required', document.getElementById('dosesRequired').value);
    formData.append('interval_days', document.getElementById('intervalDays').value);
    formData.append('current_stock', document.getElementById('currentStock').value);

    try {
        const url = vaccineId ? `/edit-vaccine/${vaccineId}/` : '/add-vaccine/';
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        });
        
        const data = await response.json();
        if (data.success) {
            closeModal();
            location.reload(); // Refresh to show updated data
        } else {
            alert(data.message || 'Error saving vaccine');
        }
    } catch (error) {
        alert('Error saving vaccine');
        console.error(error);
    }
}

async function deleteVaccine(id) {
    if (!confirm('Are you sure you want to delete this vaccine?')) return;
    
    try {
        const response = await fetch(`/delete-vaccine/${id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert(data.message);
        }
    } catch (error) {
        alert('An error occurred. Please try again.');
    }
}

// Update the search functionality to be more robust
document.getElementById('vaccineSearch').addEventListener('input', function(e) {
    const searchText = e.target.value.toLowerCase();
    const rows = document.getElementById('vaccineTableBody').getElementsByTagName('tr');
    
    for (let row of rows) {
        const cells = row.getElementsByTagName('td');
        let found = false;
        
        // Search through each cell in the row
        for (let cell of cells) {
            if (cell.textContent.toLowerCase().includes(searchText)) {
                found = true;
                break;
            }
        }
        
        // Show/hide row based on search
        row.style.display = found ? '' : 'none';
    }
});
</script>

<style>
    .vaccine-dashboard {
        padding: 2rem;
        background: var(--light-bg);
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        padding: 1.5rem;
        border-radius: 12px;
        color: white;
    }

    .primary-gradient { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); }
    .success-gradient { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
    .warning-gradient { background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%); }
    .danger-gradient { background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); }

    /* Content Grid */
    .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .dashboard-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Schedule Styling */
    .schedule-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .schedule-date {
        text-align: center;
        min-width: 60px;
    }

    .schedule-date .date {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .schedule-date .month {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    /* Stock Styling */
    .stock-item {
        padding: 1rem;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .stock-progress {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 0.5rem;
    }

    .progress-bar {
        flex: 1;
        height: 6px;
        background: var(--light-bg);
        border-radius: 3px;
        overflow: hidden;
    }

    .progress {
        height: 100%;
        background: var(--accent-color);
        border-radius: 3px;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .content-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .vaccine-dashboard {
            padding: 1rem;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .modal-content {
        background: white;
        width: 90%;
        max-width: 500px;
        margin: 50px auto;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .modal-header {
        padding: 1rem;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .form-group {
        margin: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-secondary);
    }

    .form-group input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .modal-footer {
        padding: 1rem;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }

    .btn-icon {
        background: none;
        border: none;
        padding: 0.5rem;
        cursor: pointer;
        color: var(--primary-color);
    }

    .btn-icon.danger {
        color: var(--danger-color);
    }

    .stock-indicator {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        background: var(--success-color);
        color: white;
        display: inline-block;
    }

    .stock-indicator.low {
        background: var(--danger-color);
    }
</style>
{% endblock %}
