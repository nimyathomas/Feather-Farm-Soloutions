{% extends 'stakeholder.html' %}
{% load static %}
{% block body %}

<div class="max-w-7xl mx-auto grid grid-cols-12 gap-6 p-4 min-h-screen bg-gray-50">
    <!-- Left Sidebar - Forum List -->
    <div class="col-span-4 bg-white rounded-lg shadow-sm p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-semibold text-gray-800">Discussions</h2>
            <button onclick="showNewPostModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                <i class="fas fa-plus"></i>
                New Post
            </button>
        </div>

        <!-- Forum Categories -->
        <div class="mb-6">
            <div class="flex gap-2 mb-4 overflow-x-auto">
                <button class="px-4 py-2 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">All Posts</button>
                <button class="px-4 py-2 hover:bg-gray-100 rounded-full text-sm text-gray-600">FCR Discussion</button>
                <button class="px-4 py-2 hover:bg-gray-100 rounded-full text-sm text-gray-600">Health & Safety</button>
                <button class="px-4 py-2 hover:bg-gray-100 rounded-full text-sm text-gray-600">Best Practices</button>
            </div>
        </div>

        <!-- Posts List -->
        <div class="space-y-3 overflow-y-auto max-h-[calc(100vh-300px)]">
            {% for post in posts %}
            <div class="group hover:bg-gray-50 p-4 rounded-lg border border-gray-200 cursor-pointer transition-all"
                 onclick="window.location.href='{% url 'forum' post.id %}'">
                <div class="flex items-start justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                            <span class="text-blue-600 font-semibold">{{ post.owner.full_name|make_list|first }}</span>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900 group-hover:text-blue-600 transition-colors">{{ post.title }}</h3>
                            <p class="text-sm text-gray-500">{{ post.owner.full_name }} • {{ post.created_at|timesince }} ago</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 text-sm text-gray-500">
                        <span class="flex items-center gap-1">
                            <i class="far fa-comment"></i>
                            {{ post.comment_count }}
                        </span>
                        <span class="flex items-center gap-1">
                            <i class="far fa-eye"></i>
                            {{ post.view_count }}
                        </span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Right Content - Post Detail -->
    <div class="col-span-8 bg-white rounded-lg shadow-sm p-6">
        {% if selected_post %}
            <!-- Post Header -->
            <div class="border-b pb-6 mb-6">
                <div class="flex justify-between items-start mb-4">
                    <h1 class="text-3xl font-bold text-gray-900">{{ selected_post.title }}</h1>
                    <div class="flex gap-2">
                        <button onclick="speakPost()" class="text-gray-600 hover:text-gray-800 p-2 rounded-full hover:bg-gray-100">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" class="text-gray-600 hover:text-gray-800 p-2 rounded-full hover:bg-gray-100">
                                <i class="fas fa-share-alt"></i>
                            </button>
                            <div x-show="open" @click.away="open = false" 
                                 class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg p-2 border">
                                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" 
                                   target="_blank" 
                                   class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded-lg text-gray-700">
                                    <i class="fab fa-facebook text-blue-600"></i>
                                    Facebook
                                </a>
                                <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ selected_post.title }}" 
                                   target="_blank" 
                                   class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded-lg text-gray-700">
                                    <i class="fab fa-twitter text-blue-400"></i>
                                    Twitter
                                </a>
                                <a href="https://www.linkedin.com/shareArticle?url={{ request.build_absolute_uri }}&title={{ selected_post.title }}" 
                                   target="_blank" 
                                   class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded-lg text-gray-700">
                                    <i class="fab fa-linkedin text-blue-700"></i>
                                    LinkedIn
                                </a>
                                <button onclick="copyLink()" 
                                        class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded-lg text-gray-700 w-full">
                                    <i class="fas fa-link text-gray-600"></i>
                                    Copy Link
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4 text-sm text-gray-500">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                            <span class="text-blue-600 font-semibold">{{ selected_post.owner.full_name|make_list|first }}</span>
                        </div>
                        <span>{{ selected_post.owner.full_name }}</span>
                    </div>
                    <span>•</span>
                    <span>{{ selected_post.created_at|date:"d M Y, H:i" }}</span>
                </div>
            </div>

            <!-- Post Content -->
            <div class="prose max-w-none mb-8" id="post-text">
                {{ selected_post.content|linebreaks }}
            </div>

            <!-- Comments Section -->
            <div class="border-t pt-6">
                <h3 class="text-xl font-semibold mb-6">Comments ({{ comments|length }})</h3>
                
                <!-- New Comment Form -->
                <form method="post" class="mb-8">
                    {% csrf_token %}
                    <div class="flex gap-4">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex-shrink-0 flex items-center justify-center">
                            <span class="text-blue-600 font-semibold">{{ request.user.full_name|make_list|first }}</span>
                        </div>
                        <div class="flex-grow">
                            <textarea
                                name="comment_content"
                                placeholder="Add to the discussion"
                                class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                rows="3"
                                required
                            ></textarea>
                            <button type="submit" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                Post Comment
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Comments List -->
                <div class="space-y-6">
                    {% for comment in comments %}
                    <div class="flex gap-4">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex-shrink-0 flex items-center justify-center">
                            <span class="text-blue-600 font-semibold">{{ comment.owner.full_name|make_list|first }}</span>
                        </div>
                        <div class="flex-grow">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-semibold text-gray-900">{{ comment.owner.full_name }}</span>
                                    <span class="text-sm text-gray-500">{{ comment.created_at|timesince }} ago</span>
                                </div>
                                <p class="text-gray-700">{{ comment.content }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <div class="text-center py-12">
                <i class="fas fa-comments text-gray-300 text-6xl mb-4"></i>
                <p class="text-gray-600">Select a post from the left to view its content and join the discussion.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- New Post Modal -->
<div id="newPostModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-full max-w-xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Create New Post</h3>
            <button onclick="hideNewPostModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form method="post" class="space-y-4">
            {% csrf_token %}
            <div>
                <input
                    type="text"
                    name="post_title"
                    placeholder="Post Title"
                    class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    required
                />
            </div>
            <div>
                <textarea
                    id="post_content"
                    name="post_content"
                    placeholder="Write your post content..."
                    class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    rows="6"
                    required
                ></textarea>
            </div>
            <div class="flex justify-between">
                <button type="button" onclick="startVoiceRecognition()" 
                        class="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700">
                    <i class="fas fa-microphone"></i>
                    Voice Input
                </button>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                    Publish Post
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function startVoiceRecognition() {
        if ('webkitSpeechRecognition' in window) {
            let recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                alert('Voice recognition started. Please speak...');
            };

            recognition.onresult = function(event) {
                document.getElementById('post_content').value = event.results[0][0].transcript;
            };

            recognition.onerror = function(event) {
                alert('Error occurred in recognition: ' + event.error);
            };

            recognition.start();
        } else {
            alert('Your browser does not support speech recognition.');
        }
    }

    function speakPost() {
        let text = document.getElementById("post-text").innerText;
        let speech = new SpeechSynthesisUtterance();
        speech.lang = "en-US";
        speech.text = text;
        speech.rate = 1;
        speech.pitch = 1;
        window.speechSynthesis.speak(speech);
    }

    function showNewPostModal() {
        document.getElementById('newPostModal').style.display = 'flex';
    }

    function hideNewPostModal() {
        document.getElementById('newPostModal').style.display = 'none';
    }

    function copyLink() {
        navigator.clipboard.writeText(window.location.href);
        alert('Link copied to clipboard!');
    }
</script>

{% endblock %}
